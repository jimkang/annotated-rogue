<!DOCTYPE html>

<html>
<head>
  <title>save.c</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="hit.html">
                  hit.c
                </a>
              
                
                <a class="source" href="init.html">
                  init.c
                </a>
              
                
                <a class="source" href="inventory.html">
                  inventory.c
                </a>
              
                
                <a class="source" href="level.html">
                  level.c
                </a>
              
                
                <a class="source" href="machdep.html">
                  machdep.c
                </a>
              
                
                <a class="source" href="main.html">
                  main.c
                </a>
              
                
                <a class="source" href="message.html">
                  message.c
                </a>
              
                
                <a class="source" href="monster.html">
                  monster.c
                </a>
              
                
                <a class="source" href="move.html">
                  move.c
                </a>
              
                
                <a class="source" href="object.html">
                  object.c
                </a>
              
                
                <a class="source" href="pack.html">
                  pack.c
                </a>
              
                
                <a class="source" href="pathnames.html">
                  pathnames.h
                </a>
              
                
                <a class="source" href="play.html">
                  play.c
                </a>
              
                
                <a class="source" href="random.html">
                  random.c
                </a>
              
                
                <a class="source" href="ring.html">
                  ring.c
                </a>
              
                
                <a class="source" href="rogue.html">
                  rogue.h
                </a>
              
                
                <a class="source" href="room.html">
                  room.c
                </a>
              
                
                <a class="source" href="save.html">
                  save.c
                </a>
              
                
                <a class="source" href="score.html">
                  score.c
                </a>
              
                
                <a class="source" href="spec_hit.html">
                  spec_hit.c
                </a>
              
                
                <a class="source" href="throw.html">
                  throw.c
                </a>
              
                
                <a class="source" href="trap.html">
                  trap.c
                </a>
              
                
                <a class="source" href="use.html">
                  use.c
                </a>
              
                
                <a class="source" href="zap.html">
                  zap.c
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>save.c</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/*-
</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre> * Copyright (c) <span class="hljs-number">1988</span>, <span class="hljs-number">1993</span>
 *	The Regents of the University of California.  All rights reserved.
 *</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre> * This code is derived from software contributed to Berkeley by
 * Timothy C. Stoehr.
 *</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre> * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * <span class="hljs-number">1.</span> Redistributions of source code must retain the above copyright
 *    notice, <span class="hljs-keyword">this</span> <span class="hljs-built_in">list</span> of conditions and the following disclaimer.
 * <span class="hljs-number">2.</span> Redistributions in binary form must reproduce the above copyright
 *    notice, <span class="hljs-keyword">this</span> <span class="hljs-built_in">list</span> of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 * <span class="hljs-number">3.</span> Neither the name of the University nor the names of its contributors
 *    may be used to endorse or promote products derived from <span class="hljs-keyword">this</span> software
 *    without specific prior written permission.
 *</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre> * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
 * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
 * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
 * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
 * SUCH DAMAGE.
 *</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre> * @(#)save.c	<span class="hljs-number">8.1</span> (Berkeley) <span class="hljs-number">5</span>/<span class="hljs-number">31</span>/<span class="hljs-number">93</span>
 * $FreeBSD: src/games/rogue/save.c,v <span class="hljs-number">1.6</span> <span class="hljs-number">1999</span>/<span class="hljs-number">11</span>/<span class="hljs-number">30</span> <span class="hljs-number">03</span>:<span class="hljs-number">49</span>:<span class="hljs-number">27</span> billf Exp $
 * $DragonFly: src/games/rogue/save.c,v <span class="hljs-number">1.4</span> <span class="hljs-number">2006</span>/<span class="hljs-number">09</span>/<span class="hljs-number">02</span> <span class="hljs-number">19</span>:<span class="hljs-number">31</span>:<span class="hljs-number">07</span> pavalos Exp $
 */</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/*
</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre> * save.c
 *</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre> * This source herein may be modified and/or distributed by anybody who
 * so desires, with the following restrictions:
 *    <span class="hljs-number">1.</span>)  No portion of <span class="hljs-keyword">this</span> notice shall be removed.
 *    <span class="hljs-number">2.</span>)  Credit shall not be taken <span class="hljs-keyword">for</span> the creation of <span class="hljs-keyword">this</span> source.
 *    <span class="hljs-number">3.</span>)  This code is not to be traded, sold, or used <span class="hljs-keyword">for</span> personal
 *         gain or profit.
 *</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre> */</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-string">"rogue.h"</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">extern</span> <span class="hljs-keyword">short</span> cur_level, max_level;
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">short</span> party_room;
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">short</span> foods;
<span class="hljs-keyword">extern</span> boolean is_wood[];
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">short</span> cur_room;
<span class="hljs-keyword">extern</span> boolean being_held;
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">short</span> bear_trap;
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">short</span> halluc;
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">short</span> blind;
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">short</span> confused;
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">short</span> levitate;
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">short</span> haste_self;
<span class="hljs-keyword">extern</span> boolean see_invisible;
<span class="hljs-keyword">extern</span> boolean detect_monster;
<span class="hljs-keyword">extern</span> boolean wizard;
<span class="hljs-keyword">extern</span> boolean score_only;
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">short</span> m_moves;</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">extern</span> boolean msg_cleared;</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">static</span> boolean	<span class="hljs-title">has_been_touched</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">struct</span> rogue_time *,
			 <span class="hljs-keyword">const</span> <span class="hljs-keyword">struct</span> rogue_time *)</span></span>;
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span>	<span class="hljs-title">del_save_file</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span>;
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span>	<span class="hljs-title">r_read</span><span class="hljs-params">(FILE *, <span class="hljs-keyword">char</span> *, <span class="hljs-keyword">int</span>)</span></span>;
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span>	<span class="hljs-title">r_write</span><span class="hljs-params">(FILE *, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *, <span class="hljs-keyword">int</span>)</span></span>;
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span>	<span class="hljs-title">read_pack</span><span class="hljs-params">(object *, FILE *, boolean)</span></span>;
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span>	<span class="hljs-title">read_string</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *, FILE *, size_t)</span></span>;
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span>	<span class="hljs-title">rw_dungeon</span><span class="hljs-params">(FILE *, boolean)</span></span>;
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span>	<span class="hljs-title">rw_id</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> id *, FILE *, <span class="hljs-keyword">int</span>, boolean)</span></span>;
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span>	<span class="hljs-title">rw_rooms</span><span class="hljs-params">(FILE *, boolean)</span></span>;
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span>	<span class="hljs-title">write_pack</span><span class="hljs-params">(<span class="hljs-keyword">const</span> object *, FILE *)</span></span>;
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span>	<span class="hljs-title">write_string</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *, FILE *)</span></span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">short</span> write_failed = <span class="hljs-number">0</span>;
<span class="hljs-keyword">char</span> *save_file = <span class="hljs-literal">NULL</span>;
<span class="hljs-keyword">static</span> <span class="hljs-keyword">char</span> save_name[<span class="hljs-number">80</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">void</span>
<span class="hljs-title">save_game</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">char</span> fname[<span class="hljs-number">64</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span> (!get_input_line(<span class="hljs-string">"file name?"</span>, save_file, fname,
			<span class="hljs-string">"game not saved"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>)) {
		return;
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>	check_message();
	message(fname, <span class="hljs-number">0</span>);
	save_into_file(fname);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">void</span>
<span class="hljs-title">save_into_file</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *sfile)</span>
</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>	FILE *fp;
	<span class="hljs-keyword">int</span> file_id;
	<span class="hljs-keyword">char</span> *name_buffer;
	<span class="hljs-keyword">size_t</span> len;
	<span class="hljs-keyword">char</span> *hptr;
	<span class="hljs-keyword">struct</span> rogue_time rt_buf;</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span> (sfile[<span class="hljs-number">0</span>] == <span class="hljs-string">'~'</span>) {
		<span class="hljs-keyword">if</span> ((hptr = md_getenv(<span class="hljs-string">"HOME"</span>)) != <span class="hljs-literal">NULL</span>) {
			len = <span class="hljs-built_in">strlen</span>(hptr) + <span class="hljs-built_in">strlen</span>(sfile);
			name_buffer = (char *) md_malloc(len);
			<span class="hljs-keyword">if</span> (name_buffer == <span class="hljs-literal">NULL</span>) {
				message(<span class="hljs-string">"out of memory for save file name"</span>, <span class="hljs-number">0</span>);
				sfile = error_file;
			} <span class="hljs-keyword">else</span> {
				<span class="hljs-built_in">strcpy</span>(name_buffer, hptr);
				<span class="hljs-built_in">strcat</span>(name_buffer, sfile+<span class="hljs-number">1</span>);
				sfile = name_buffer;
			}</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>		}</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>	}</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-comment">/* revoke */</span>
	setgid(getgid());
	<span class="hljs-keyword">if</span> (	((fp = fopen(sfile, <span class="hljs-string">"w"</span>)) == NULL) ||
			((file_id = md_get_file_id(sfile)) == <span class="hljs-number">-1</span>)) {
		message(<span class="hljs-string">"problem accessing the save file"</span>, <span class="hljs-number">0</span>);
		return;
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>	md_ignore_signals();
	write_failed = <span class="hljs-number">0</span>;
	xxx(<span class="hljs-number">1</span>);
	r_write(fp, (char *) &amp;detect_monster, <span class="hljs-keyword">sizeof</span>(detect_monster));
	r_write(fp, (char *) &amp;cur_level, <span class="hljs-keyword">sizeof</span>(cur_level));
	r_write(fp, (char *) &amp;max_level, <span class="hljs-keyword">sizeof</span>(max_level));
	write_string(hunger_str, fp);
	write_string(login_name, fp);
	r_write(fp, (char *) &amp;party_room, <span class="hljs-keyword">sizeof</span>(party_room));
	write_pack(&amp;level_monsters, fp);
	write_pack(&amp;level_objects, fp);
	r_write(fp, (char *) &amp;file_id, <span class="hljs-keyword">sizeof</span>(file_id));
	rw_dungeon(fp, <span class="hljs-number">1</span>);
	r_write(fp, (char *) &amp;foods, <span class="hljs-keyword">sizeof</span>(foods));
	r_write(fp, (char *) &amp;rogue, <span class="hljs-keyword">sizeof</span>(fighter));
	write_pack(&amp;rogue.pack, fp);
	rw_id(id_potions, fp, POTIONS, <span class="hljs-number">1</span>);
	rw_id(id_scrolls, fp, SCROLS, <span class="hljs-number">1</span>);
	rw_id(id_wands, fp, WANDS, <span class="hljs-number">1</span>);
	rw_id(id_rings, fp, RINGS, <span class="hljs-number">1</span>);
	r_write(fp, (char *) traps, (MAX_TRAPS * sizeof(trap)));
	r_write(fp, (char *) is_wood, (WANDS * sizeof(boolean)));
	r_write(fp, (char *) &amp;cur_room, <span class="hljs-keyword">sizeof</span>(cur_room));
	rw_rooms(fp, <span class="hljs-number">1</span>);
	r_write(fp, (char *) &amp;being_held, <span class="hljs-keyword">sizeof</span>(being_held));
	r_write(fp, (char *) &amp;bear_trap, <span class="hljs-keyword">sizeof</span>(bear_trap));
	r_write(fp, (char *) &amp;halluc, <span class="hljs-keyword">sizeof</span>(halluc));
	r_write(fp, (char *) &amp;blind, <span class="hljs-keyword">sizeof</span>(blind));
	r_write(fp, (char *) &amp;confused, <span class="hljs-keyword">sizeof</span>(confused));
	r_write(fp, (char *) &amp;levitate, <span class="hljs-keyword">sizeof</span>(levitate));
	r_write(fp, (char *) &amp;haste_self, <span class="hljs-keyword">sizeof</span>(haste_self));
	r_write(fp, (char *) &amp;see_invisible, <span class="hljs-keyword">sizeof</span>(see_invisible));
	r_write(fp, (char *) &amp;detect_monster, <span class="hljs-keyword">sizeof</span>(detect_monster));
	r_write(fp, (char *) &amp;wizard, <span class="hljs-keyword">sizeof</span>(wizard));
	r_write(fp, (char *) &amp;score_only, <span class="hljs-keyword">sizeof</span>(score_only));
	r_write(fp, (char *) &amp;m_moves, <span class="hljs-keyword">sizeof</span>(m_moves));
	md_gct(&amp;rt_buf);
	rt_buf.second += <span class="hljs-number">10</span>;		<span class="hljs-comment">/* allow for some processing time */</span>
	r_write(fp, (char *) &amp;rt_buf, <span class="hljs-keyword">sizeof</span>(rt_buf));
	fclose(fp);</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span> (write_failed) {
		md_df(sfile);	<span class="hljs-comment">/* delete file */</span>
	} <span class="hljs-keyword">else</span> {
		<span class="hljs-keyword">if</span> (strcmp(sfile, save_name) == <span class="hljs-number">0</span>)
			save_name[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;
		clean_up(<span class="hljs-string">""</span>);
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>}</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span>
<span class="hljs-title">del_save_file</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span> (!save_name[<span class="hljs-number">0</span>])
		return;
	<span class="hljs-comment">/* revoke */</span>
	setgid(getgid());
	md_df(save_name);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">void</span>
<span class="hljs-title">restore</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *fname)</span>
</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>	FILE *fp = <span class="hljs-literal">NULL</span>;
	<span class="hljs-keyword">struct</span> rogue_time saved_time, mod_time;
	<span class="hljs-keyword">char</span> buf[<span class="hljs-number">4</span>];
	<span class="hljs-keyword">char</span> tbuf[<span class="hljs-number">40</span>];
	<span class="hljs-keyword">int</span> new_file_id, saved_file_id;</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span> (	((new_file_id = md_get_file_id(fname)) == <span class="hljs-number">-1</span>) ||
			((fp = fopen(fname, <span class="hljs-string">"r"</span>)) == NULL)) {
		clean_up(<span class="hljs-string">"cannot open file"</span>);
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span> (md_link_count(fname) &gt; <span class="hljs-number">1</span>) {
		clean_up(<span class="hljs-string">"file has link"</span>);
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>	xxx(<span class="hljs-number">1</span>);
	r_read(fp, (char *) &amp;detect_monster, <span class="hljs-keyword">sizeof</span>(detect_monster));
	r_read(fp, (char *) &amp;cur_level, <span class="hljs-keyword">sizeof</span>(cur_level));
	r_read(fp, (char *) &amp;max_level, <span class="hljs-keyword">sizeof</span>(max_level));
	read_string(hunger_str, fp, <span class="hljs-keyword">sizeof</span> hunger_str);</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>	strlcpy(tbuf, login_name, <span class="hljs-keyword">sizeof</span> tbuf);
	read_string(login_name, fp, <span class="hljs-keyword">sizeof</span> login_name);
	<span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(tbuf, login_name)) {
		clean_up(<span class="hljs-string">"you're not the original player"</span>);
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>	r_read(fp, (char *) &amp;party_room, <span class="hljs-keyword">sizeof</span>(party_room));
	read_pack(&amp;level_monsters, fp, <span class="hljs-number">0</span>);
	read_pack(&amp;level_objects, fp, <span class="hljs-number">0</span>);
	r_read(fp, (char *) &amp;saved_file_id, <span class="hljs-keyword">sizeof</span>(saved_file_id));
	<span class="hljs-keyword">if</span> (new_file_id != saved_file_id) {
		clean_up(<span class="hljs-string">"sorry, saved game is not in the same file"</span>);
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>	rw_dungeon(fp, <span class="hljs-number">0</span>);
	r_read(fp, (char *) &amp;foods, <span class="hljs-keyword">sizeof</span>(foods));
	r_read(fp, (char *) &amp;rogue, <span class="hljs-keyword">sizeof</span>(fighter));
	read_pack(&amp;rogue.pack, fp, <span class="hljs-number">1</span>);
	rw_id(id_potions, fp, POTIONS, <span class="hljs-number">0</span>);
	rw_id(id_scrolls, fp, SCROLS, <span class="hljs-number">0</span>);
	rw_id(id_wands, fp, WANDS, <span class="hljs-number">0</span>);
	rw_id(id_rings, fp, RINGS, <span class="hljs-number">0</span>);
	r_read(fp, (char *) traps, (MAX_TRAPS * sizeof(trap)));
	r_read(fp, (char *) is_wood, (WANDS * sizeof(boolean)));
	r_read(fp, (char *) &amp;cur_room, <span class="hljs-keyword">sizeof</span>(cur_room));
	rw_rooms(fp, <span class="hljs-number">0</span>);
	r_read(fp, (char *) &amp;being_held, <span class="hljs-keyword">sizeof</span>(being_held));
	r_read(fp, (char *) &amp;bear_trap, <span class="hljs-keyword">sizeof</span>(bear_trap));
	r_read(fp, (char *) &amp;halluc, <span class="hljs-keyword">sizeof</span>(halluc));
	r_read(fp, (char *) &amp;blind, <span class="hljs-keyword">sizeof</span>(blind));
	r_read(fp, (char *) &amp;confused, <span class="hljs-keyword">sizeof</span>(confused));
	r_read(fp, (char *) &amp;levitate, <span class="hljs-keyword">sizeof</span>(levitate));
	r_read(fp, (char *) &amp;haste_self, <span class="hljs-keyword">sizeof</span>(haste_self));
	r_read(fp, (char *) &amp;see_invisible, <span class="hljs-keyword">sizeof</span>(see_invisible));
	r_read(fp, (char *) &amp;detect_monster, <span class="hljs-keyword">sizeof</span>(detect_monster));
	r_read(fp, (char *) &amp;wizard, <span class="hljs-keyword">sizeof</span>(wizard));
	r_read(fp, (char *) &amp;score_only, <span class="hljs-keyword">sizeof</span>(score_only));
	r_read(fp, (char *) &amp;m_moves, <span class="hljs-keyword">sizeof</span>(m_moves));
	r_read(fp, (char *) &amp;saved_time, <span class="hljs-keyword">sizeof</span>(saved_time));</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span> (fread(buf, sizeof(char), <span class="hljs-number">1</span>, fp) &gt; <span class="hljs-number">0</span>) {
		clear();
		clean_up(<span class="hljs-string">"extra characters in file"</span>);
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>	md_gfmt(fname, &amp;mod_time);	<span class="hljs-comment">/* get file modification time */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span> (has_been_touched(&amp;saved_time, &amp;mod_time)) {
		clear();
		clean_up(<span class="hljs-string">"sorry, file has been touched"</span>);
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span> ((!wizard)) {
		<span class="hljs-built_in">strcpy</span>(save_name, fname);
		atexit(del_save_file);
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>	msg_cleared = <span class="hljs-number">0</span>;
	ring_stats(<span class="hljs-number">0</span>);
	fclose(fp);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span>
<span class="hljs-title">write_pack</span><span class="hljs-params">(<span class="hljs-keyword">const</span> object *pack, FILE *fp)</span>
</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>	object t;</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">while</span> ((pack = pack-&gt;next_object) != <span class="hljs-literal">NULL</span>) {
		r_write(fp, (const char *) pack, <span class="hljs-keyword">sizeof</span>(object));
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>	t.ichar = t.what_is = <span class="hljs-number">0</span>;
	r_write(fp, (const char *) &amp;t, <span class="hljs-keyword">sizeof</span>(object));
}</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span>
<span class="hljs-title">read_pack</span><span class="hljs-params">(object *pack, FILE *fp, boolean is_rogue)</span>
</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>	object read_obj, *new_obj;</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">for</span> (;;) {
		r_read(fp, (char *) &amp;read_obj, <span class="hljs-keyword">sizeof</span>(object));
		<span class="hljs-keyword">if</span> (read_obj.ichar == <span class="hljs-number">0</span>) {
			pack-&gt;next_object = <span class="hljs-literal">NULL</span>;
			<span class="hljs-keyword">break</span>;
		}</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>		new_obj = alloc_object();
		*new_obj = read_obj;
		<span class="hljs-keyword">if</span> (is_rogue) {
			<span class="hljs-keyword">if</span> (new_obj-&gt;in_use_flags &amp; BEING_WORN) {
				do_wear(new_obj);
			} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (new_obj-&gt;in_use_flags &amp; BEING_WIELDED) {
				do_wield(new_obj);
			} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (new_obj-&gt;in_use_flags &amp; (ON_EITHER_HAND)) {
				do_put_on(new_obj,
					((new_obj-&gt;in_use_flags &amp; ON_LEFT_HAND) ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>));
			}</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>		}</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>		pack-&gt;next_object = new_obj;
		pack = new_obj;
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>}</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span>
<span class="hljs-title">rw_dungeon</span><span class="hljs-params">(FILE *fp, boolean rw)</span>
</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">short</span> i, j;
	<span class="hljs-keyword">char</span> buf[DCOLS];</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; DROWS; i++) {
		<span class="hljs-keyword">if</span> (rw) {
			r_write(fp, (char *) dungeon[i], (DCOLS * sizeof(dungeon[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>])));
			<span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; DCOLS; j++) {
				buf[j] = (short ) mvinch(i, j);
			}</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>			r_write(fp, buf, DCOLS);
		} <span class="hljs-keyword">else</span> {
			r_read(fp, (char *) dungeon[i], (DCOLS * sizeof(dungeon[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>])));
			r_read(fp, buf, DCOLS);
			<span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; DCOLS; j++) {
				mvaddch(i, j, buf[j]);
			}</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>		}</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>	}</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>}</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span>
<span class="hljs-title">rw_id</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> id id_table[], FILE *fp, <span class="hljs-keyword">int</span> n, boolean wr)</span>
</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">short</span> i;</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; n; i++) {
		<span class="hljs-keyword">if</span> (wr) {
			r_write(fp, (const char *) &amp;(id_table[i].value), <span class="hljs-keyword">sizeof</span>(short));
			r_write(fp, (const char *) &amp;(id_table[i].id_status),
				<span class="hljs-keyword">sizeof</span>(unsigned short));
			write_string(id_table[i].title, fp);
		} <span class="hljs-keyword">else</span> {
			r_read(fp, (char *) &amp;(id_table[i].value), sizeof(short));
			r_read(fp, (char *) &amp;(id_table[i].id_status),
				<span class="hljs-keyword">sizeof</span>(unsigned short));
			read_string(id_table[i].title, fp, MAX_ID_TITLE_LEN);
		}</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>	}</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>}</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span>
<span class="hljs-title">write_string</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *s, FILE *fp)</span>
</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">short</span> n;</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>	n = <span class="hljs-built_in">strlen</span>(s) + <span class="hljs-number">1</span>;
	xxxx(s, n);
	r_write(fp, (char *) &amp;n, <span class="hljs-keyword">sizeof</span>(short));
	r_write(fp, s, n);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span>
<span class="hljs-title">read_string</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *s, FILE *fp, size_t len)</span>
</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">short</span> n;</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>	r_read(fp, (char *) &amp;n, <span class="hljs-keyword">sizeof</span>(short));
	<span class="hljs-keyword">if</span> (n &gt; (short)len)
		clean_up(<span class="hljs-string">"read_string: corrupt game file"</span>);
	r_read(fp, s, n);
	xxxx(s, n);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span>
<span class="hljs-title">rw_rooms</span><span class="hljs-params">(FILE *fp, boolean rw)</span>
</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">short</span> i;</pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; MAXROOMS; i++) {
		rw ? r_write(fp, (char *) (rooms + i), <span class="hljs-keyword">sizeof</span>(room)) :
			r_read(fp, (char *) (rooms + i), <span class="hljs-keyword">sizeof</span>(room));
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>}</pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span>
<span class="hljs-title">r_read</span><span class="hljs-params">(FILE *fp, <span class="hljs-keyword">char</span> *buf, <span class="hljs-keyword">int</span> n)</span>
</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-94">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span> (fread(buf, sizeof(char), n, fp) != (unsigned)n) {
		clean_up(<span class="hljs-string">"read() failed, don't know why"</span>);
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-95">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>}</pre></div></div>
            
        </li>
        
        
        <li id="section-96">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-96">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-97">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-97">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span>
<span class="hljs-title">r_write</span><span class="hljs-params">(FILE *fp, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *buf, <span class="hljs-keyword">int</span> n)</span>
</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-98">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-98">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span> (!write_failed) {
		<span class="hljs-keyword">if</span> (fwrite(buf, sizeof(char), n, fp) != (unsigned)n) {
			message(<span class="hljs-string">"write() failed, don't know why"</span>, <span class="hljs-number">0</span>);
			sound_bell();
			write_failed = <span class="hljs-number">1</span>;
		}</pre></div></div>
            
        </li>
        
        
        <li id="section-99">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-99">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>	}</pre></div></div>
            
        </li>
        
        
        <li id="section-100">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-100">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>}</pre></div></div>
            
        </li>
        
        
        <li id="section-101">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-101">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-102">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-102">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">static</span> boolean
<span class="hljs-title">has_been_touched</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">struct</span> rogue_time *saved_time,
		 <span class="hljs-keyword">const</span> <span class="hljs-keyword">struct</span> rogue_time *mod_time)</span>
</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-103">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-103">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span> (saved_time-&gt;year &lt; mod_time-&gt;year) {
		return(<span class="hljs-number">1</span>);
	} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (saved_time-&gt;year &gt; mod_time-&gt;year) {
		return(<span class="hljs-number">0</span>);
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-104">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-104">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span> (saved_time-&gt;month &lt; mod_time-&gt;month) {
		return(<span class="hljs-number">1</span>);
	} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (saved_time-&gt;month &gt; mod_time-&gt;month) {
		return(<span class="hljs-number">0</span>);
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-105">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-105">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span> (saved_time-&gt;day &lt; mod_time-&gt;day) {
		return(<span class="hljs-number">1</span>);
	} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (saved_time-&gt;day &gt; mod_time-&gt;day) {
		return(<span class="hljs-number">0</span>);
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-106">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-106">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span> (saved_time-&gt;hour &lt; mod_time-&gt;hour) {
		return(<span class="hljs-number">1</span>);
	} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (saved_time-&gt;hour &gt; mod_time-&gt;hour) {
		return(<span class="hljs-number">0</span>);
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-107">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-107">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span> (saved_time-&gt;minute &lt; mod_time-&gt;minute) {
		return(<span class="hljs-number">1</span>);
	} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (saved_time-&gt;minute &gt; mod_time-&gt;minute) {
		return(<span class="hljs-number">0</span>);
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-108">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-108">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span> (saved_time-&gt;second &lt; mod_time-&gt;second) {
		return(<span class="hljs-number">1</span>);
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-109">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-109">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>	return(<span class="hljs-number">0</span>);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-110">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-110">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-111">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-111">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
